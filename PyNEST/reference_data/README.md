# Reference data

Here, we provide scripts to generate, analyze, and visualize reference data for the microcircuit model, which may be useful to verify alternative implementations of the model.

## Data generation

The reference data is generated by [`generate_reference_data.py`](generate_reference_data.py).

Usage:
```bash
python generate_reference_data.py --seed <RNGseed> --path <data_path>
```

The script uses the parameters defined in [`params.py`](params.py), which overwrite some of the default parameters in [source](../src/microcircuit).
The random number generator seed and the data path can be set via the (optional) command line arguments `<RNGseed>` and `<data_path>`.

## Sets of reference data

For convenience, we provide sets of pre-simulated reference data for different simulation times and network realizations (RNGseeds) at [LinkToZenodo]().

The spike data is stored in text files `data_T<sim_time_in_s>s/seed-<RNGseed>/spike_recorder-<rec-id>-<thread-id>.dat` (1st column: neuron ID, 2nd column: spike time in ms). Here, `<sim_time_in_s>` refers to the simulation time in seconds, `<RNGseed>` to the random number generator seed to generate a specific realization of the model, `<rec-id>` to the population specific spike-recorder ID, and `<thread-id>` to the thread ID.
Each subfolder in addition contains metadata documenting the node IDs for each neuron population (`nodes.json`) as well as the complete sets of model and simulation parameters (`sim_dict.json`, `net_dict.json`, `stim_dict.json`).
  
## Data analysis
In [`analyze_reference_data.py`](analyze_reference_data.py) one finds an example implementation of the analysis of statistics within one single realization of the network:
* calculates spike statistics (time averaged single neuron firing rates and ISI CVs for each neuron, and spike count correlation coefficients for a subset of 250 neurons) in each population for ten different network realizations.
* has integrated two arguments as commands from the terminal:
  * `--seed`: updates the parameter `rng_seed` in [`sim_params.py`](../src/microcircuit/sim_params.py) which ensures reproducibility of the experiment.
  * `--path`: updates the parameter `data_path` in [`sim_params.py`](../src/microcircuit/sim_params.py) to ensure correct data storage (without overwriting simulations with different seeds).

In [compute_ensemble_stats.py](compute_ensemble_stats.py) one finds an example implementation of the analysis of ensemble statistics comparing different realizations of the network:
* concatenates the data from all seeds for ensemble analysis.
* calculates distributions of spike statistics for each population and each network realization
* calculates Kolmogorov-Smirnoff (KS) distances for each pair of network realizations

The exact analysis follows the paper [Dasbach et al., 2021](https://doi.org/10.3389/fnins.2021.757790), for more infromation on the exact methods please refere to it.


## Data visualization
In [plot_reference_analysis.py](plot_reference_analysis.py) one finds an example implementation to plot the reference analysis done by the other scripts:
* plot distributions of spike statistics for each population and each network realization
  * additionaly, it computes the mean and standard deviated distribution over seeds for each population.

| sim time |rate | ISI CV | CC |
|--|--|--|--|
| $`T = 900`$s | <img src="figures/rate_distributions_T900s.png" width="300"/> | <img src="figures/spike_cvs_distributions_T900s.png" width="300"/> | <img src="figures/spike_ccs_distributions_T900s.png" width="300"/> |

* plot distributions of KS distances across pairs of network realizations for each spike statistics and each population
  * the idea is that the user can compare own implementations of the model and compute the KS distance of his own distributions to the reference implementation to ensure that it falls within the bounds of the reference distributions of the KS histograms
  * additionaly, it computes the mean and standard deviation of the distribution for each population.

| sim time |rate | ISI CV | CC |
|--|--|--|--|
| $`T = 900`$s | <img src="figures/rate_KS_distances_T900s.png" width="300"/> | <img src="figures/spike_cvs_KS_distances_T900s.png" width="300"/> | <img src="figures/spike_ccs_KS_distances_T900s.png" width="300"/> |

## Cluster submission workflow
Specific for slurm queing system:
* [`env.sh`](cluster_submission/env.sh):
  * contains the necessary modules to be loaded and path to source an environment containing the `microcircuit-package` (see [installation README](../README.md)) on the local cluster
* [`run_benchmark.sh`](cluster_submission/run_benchmark.sh):
  * contains the workflow to submit ten parallel jobs on the cluster, each with a different realization of the network
* [`run_job.sh`](cluster_submission/run_job.sh):
  * contains the bash command to start the simulation for each job and run the analysis per seed after simulation's end
  * it also contains specifications about the necessary resources


